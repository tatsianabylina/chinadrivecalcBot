const { Telegraf } = require('telegraf');
const express = require('express');

// === –¢–û–ö–ï–ù –ë–û–¢–ê (–∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è) ===
const BOT_TOKEN = process.env.BOT_TOKEN;
const bot = new Telegraf(BOT_TOKEN);

// === –ù–ê–°–¢–†–û–ô–ö–ò ===
const COST_PER_KG = 24;        // BYN –∑–∞ 1 –∫–≥
const CNY_TO_BYN = 0.64;       // 1 —é–∞–Ω—å = 0.64 BYN

// === –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ ===
const menuButtons = {
  reply_markup: {
    keyboard: [
      ['üßÆ –ü—Ä–æ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π'],
      ['üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º']
    ],
    resize_keyboard: true
  }
};

// === –°–û–°–¢–û–Ø–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===
const userState = {};

// === –ö–û–ú–ê–ù–î–ê /start ===
bot.start((ctx) => {
  ctx.reply(
    `üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ä–∞—Å—á—ë—Ç—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ —Å —É—á–µ—Ç–æ–º –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–∑ –ö–∏—Ç–∞—è (–ø—Ä–∏ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–º –≤—ã–∫—É–ø–µ) –î–ª—è –ø—Ä–æ—Å—á–µ—Ç–∞ –∫—Ä—É–ø–Ω–æ–≥–∞–±–∞—Ä–∏—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–∞–≤—Ç–æ–∑–∞–ø—á–∞—Å—Ç–∏, –º–µ–±–µ–ª—å, —Ç–µ—Ö–Ω–∏–∫–∞, –¥—Ä) - –≤—ã–±–µ—Ä–∏—Ç–µ –≤ –º–µ–Ω—é - –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`,
    menuButtons
  );
});

// === –ö–ù–û–ü–ö–ê: –ü—Ä–æ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ –ø—Ä–∏ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–º –≤—ã–∫—É–ø–µ ===
bot.hears('üßÆ –ü—Ä–æ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π', (ctx) => {
  userState[ctx.from.id] = { step: 'waiting_weight' };
  ctx.reply('üì¶ –í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –ø–æ—Å—ã–ª–∫–∏ –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2.5)');
});

// === –ö–ù–û–ü–ö–ê: –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º ===
bot.hears('üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º', (ctx) => {
  ctx.reply(
    'üì≤ –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: @Tatiana_Bylina\n–û–Ω –æ—Ç–≤–µ—Ç–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç!'
  );
});

// === –û–ë–†–ê–ë–û–¢–ö–ê –í–í–û–î–ê (–≤–µ—Å –∏ —Ü–µ–Ω–∞) ===
bot.on('text', (ctx) => {
  const userId = ctx.from.id;
  const state = userState[userId];
  const text = ctx.message.text.trim();

  if (!state) return;

  // –®–∞–≥ 1: –í–≤–æ–¥ –≤–µ—Å–∞
  if (state.step === 'waiting_weight') {
    const weight = parseFloat(text);

    if (isNaN(weight) || weight <= 0) {
      return ctx.reply('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1.5)');
    }

    userState[userId] = { step: 'waiting_price', weight };
    return ctx.reply('üí∞ –í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞ –≤ —é–∞–Ω—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: 400)');
  }

  // –®–∞–≥ 2: –í–≤–æ–¥ —Ü–µ–Ω—ã
  if (state.step === 'waiting_price') {
    const priceCNY = parseFloat(text);

    if (isNaN(priceCNY) || priceCNY < 0) {
      return ctx.reply('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö.');
    }

    const { weight } = state;
    const deliveryCost = weight * COST_PER_KG;
    const itemCostBYN = priceCNY * CNY_TO_BYN;
    const total = deliveryCost + itemCostBYN;

    const resultText = `
üì¶ *–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞:*

‚Ä¢ –í–µ—Å: *${weight} –∫–≥*
‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞: *${deliveryCost.toFixed(2)} BYN* (–ø–æ ${COST_PER_KG} BYN/–∫–≥)
‚Ä¢ –¢–æ–≤–∞—Ä: *${priceCNY} CNY* ‚Üí *${itemCostBYN.toFixed(2)} BYN* (–ø–æ –∫—É—Ä—Å—É 1 CNY = ${CNY_TO_BYN} BYN)
‚Ä¢ –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: *${total.toFixed(2)} BYN*

–†–∞—Å—á–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –≤–µ—Å–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–≤–µ–ª–∏, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–µ—Å —Ç–æ–≤–∞—Ä–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è! üöÄ
    `.trim();

    ctx.reply(resultText, { parse_mode: 'Markdown' });

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    delete userState[userId];

    // –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é
    setTimeout(() => {
      ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ:', menuButtons);
    }, 1000);
  }
});

// === –í–ï–ë-–°–ï–†–í–ï–† –î–õ–Ø RENDER ===
const app = express();
app.use(express.json());
app.use(bot.webhookCallback('/'));

// –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–¥–ª—è UptimeRobot)
app.get('/', (req, res) => {
  res.send('‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! Webhook –∞–∫—Ç–∏–≤–µ–Ω.');
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});

// === –ó–ê–ü–£–°–ö –ë–û–¢–ê ===
bot.launch()
  .then(() => console.log('‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!'))
  .catch(err => console.error('üî¥ –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:', err));
